// Prisma Schema for Norwegian Labor Law Compliant Roster SaaS
// Enhanced with Competitive Features: Shift Marketplace, Time-Off, Accruals, Labor Costs

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User roles for RBAC
enum UserRole {
  ADMIN           // Full system access
  MANAGER         // Can create and publish rosters
  REPRESENTATIVE  // Employee representative (tillitsvalgt) - can review and comment
  EMPLOYEE        // Can view own schedule and submit preferences
}

// Roster status for workflow
enum RosterStatus {
  DRAFT           // Being created, not visible to employees
  IN_REVIEW       // Sent to representatives for approval
  PUBLISHED       // Published to employees
  ACTIVE          // Currently active roster period
  COMPLETED       // Past roster period
  ARCHIVED        // Archived for compliance (retained per law)
}

// Shift change reasons (for logging)
enum ChangeReason {
  SICK_LEAVE
  EMERGENCY
  EMPLOYEE_REQUEST
  OPERATIONAL_NEED
  CORRECTION
  OTHER
}

// Shift marketplace status
enum MarketplaceStatus {
  AVAILABLE
  CLAIMED
  APPROVED
  REJECTED
  EXPIRED
  CANCELLED
}

// Shift swap status
enum SwapStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// Time off request types
enum TimeOffType {
  VACATION
  SICK_LEAVE
  PERSONAL
  PARENTAL
  BEREAVEMENT
  UNPAID
  OTHER
}

// Time off request status
enum TimeOffStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// Accrual balance types
enum AccrualType {
  VACATION
  SICK_LEAVE
  COMP_TIME
  PARENTAL_LEAVE
}

// Dashboard metric types
enum MetricType {
  LABOR_COST
  COMPLIANCE_RATE
  ATTENDANCE_RATE
  OVERTIME_HOURS
  SHIFT_COVERAGE
  EMPLOYEE_SATISFACTION
}

// User/Employee model
model User {
  id                String            @id @default(uuid())
  email             String            @unique
  passwordHash      String?           // Optional - users can use magic link login
  role              UserRole          @default(EMPLOYEE)

  // Magic link authentication
  magicLinkToken    String?           @unique
  magicLinkExpires  DateTime?

  // Organization (for multi-tenant support)
  organizationId    String?
  organization      Organization?     @relation(fields: [organizationId], references: [id])

  // Personal information
  firstName         String
  lastName          String
  phoneNumber       String?

  // Employment details
  employeeNumber    String?           @unique
  department        String?
  position          String?
  hireDate          DateTime?

  // Labor cost tracking
  hourlyRate        Decimal?          @db.Decimal(10, 2)  // For labor cost calculation

  // Multi-location support
  locationId        String?
  location          Location?         @relation(fields: [locationId], references: [id])

  // Settings
  isActive          Boolean           @default(true)
  preferredLocale   String            @default("no")

  // Timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lastLoginAt       DateTime?

  // Relations
  shiftsAssigned    Shift[]
  preferences       EmployeePreference[]
  comments          RosterComment[]
  notifications     Notification[]
  actualHours       ActualHours[]
  messagesSent      Message[]         @relation("MessagesSent")
  messagesReceived  Message[]         @relation("MessagesReceived")
  broadcastsSent    Broadcast[]       @relation("BroadcastsSent")

  // New relations for enhanced features
  shiftSwapsRequested     ShiftSwapRequest[]  @relation("RequestedBy")
  shiftSwapsTarget        ShiftSwapRequest[]  @relation("TargetEmployee")
  timeOffRequests         TimeOffRequest[]
  accrualBalances         AccrualBalance[]
  shiftMarketplaceClaims  ShiftMarketplaceListing[]  @relation("ClaimedBy")

  @@index([email])
  @@index([employeeNumber])
  @@index([role])
  @@index([locationId])
  @@index([organizationId])
  @@index([magicLinkToken])
}

// Organization/Company model
model Organization {
  id                String            @id @default(uuid())
  name              String
  orgNumber         String            @unique  // Norwegian org number
  address           String?
  contactEmail      String
  contactPhone      String?

  // Compliance settings
  maxDailyHours     Int               @default(9)
  maxWeeklyHours    Int               @default(40)
  minDailyRest      Int               @default(11)
  minWeeklyRest     Int               @default(35)
  publishDeadline   Int               @default(14)  // Days before roster start

  // Labor cost settings
  laborBudgetPerWeek Decimal?         @db.Decimal(10, 2)
  overtimePremium    Decimal          @default(1.4) @db.Decimal(3, 2)  // Norwegian minimum: 40%

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  users             User[]
  rosters           Roster[]
  locations         Location[]
}

// Multi-location support
model Location {
  id                String            @id @default(uuid())
  organizationId    String
  organization      Organization      @relation(fields: [organizationId], references: [id])

  name              String
  address           String?
  city              String?
  region            String?
  country           String            @default("NO")
  timezone          String            @default("Europe/Oslo")

  // Labor settings
  laborBudgetPerWeek Decimal?         @db.Decimal(10, 2)
  maxEmployees      Int?

  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  users             User[]
  rosters           Roster[]

  @@index([organizationId])
}

// Roster (vaktplan) model
model Roster {
  id                String            @id @default(uuid())
  organizationId    String
  organization      Organization      @relation(fields: [organizationId], references: [id])

  // Period
  name              String            // e.g., "January 2024 Schedule"
  startDate         DateTime
  endDate           DateTime

  // Status and workflow
  status            RosterStatus      @default(DRAFT)

  // 14-Day Rule tracking
  publishedAt       DateTime?         // When roster was published
  publishedBy       String?           // User ID who published
  isLatePublication Boolean           @default(false)  // Flag if published late

  // Approval workflow
  sentForReviewAt   DateTime?
  reviewedBy        String?           // Representative user ID
  reviewedAt        DateTime?
  reviewComments    String?

  // Metadata
  createdBy         String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  shifts            Shift[]
  comments          RosterComment[]
  auditLogs         AuditLog[]
  messages          Message[]
  broadcasts        Broadcast[]
  laborCosts        LaborCost[]
  location          Location?         @relation(fields: [locationId], references: [id])
  locationId        String?
  consensusDecisions ConsensusDecision[]

  @@index([organizationId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([publishedAt])
  @@index([locationId])
}

// Shift model
model Shift {
  id                String            @id @default(uuid())
  rosterId          String
  roster            Roster            @relation(fields: [rosterId], references: [id], onDelete: Cascade)

  userId            String
  user              User              @relation(fields: [userId], references: [id])

  // Shift details
  startTime         DateTime
  endTime           DateTime
  breakMinutes      Int               @default(0)  // Unpaid break time

  // Location/department
  department        String?
  location          String?
  notes             String?

  // Labor cost tracking
  hourlyRate        Decimal?          @db.Decimal(10, 2)  // Override user's rate
  laborCost         Decimal?          @db.Decimal(10, 2)  // Calculated cost

  // Compliance flags
  violatesRestPeriod Boolean          @default(false)
  violatesDailyLimit Boolean          @default(false)
  violatesWeeklyLimit Boolean         @default(false)
  isOvertime        Boolean           @default(false)

  // Change tracking
  isChanged         Boolean           @default(false)
  originalStartTime DateTime?
  originalEndTime   DateTime?
  changeReason      ChangeReason?
  changeNotes       String?
  changedAt         DateTime?
  changedBy         String?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations for enhanced features
  marketplaceListing ShiftMarketplaceListing?
  swapRequests       ShiftSwapRequest[]  @relation("RequestedShift")
  offeredSwaps       ShiftSwapRequest[]  @relation("OfferedShift")

  @@index([rosterId])
  @@index([userId])
  @@index([startTime, endTime])
  @@index([violatesRestPeriod, violatesDailyLimit, violatesWeeklyLimit])
}

// Shift Marketplace - Employees can claim available shifts
model ShiftMarketplaceListing {
  id                String            @id @default(uuid())
  shiftId           String            @unique
  shift             Shift             @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  postedBy          String            // Manager or employee giving up shift
  postedAt          DateTime          @default(now())
  availableUntil    DateTime          // Deadline to claim

  reason            String?           // Why shift is available
  eligibleRoles     String[]          // Which roles can claim (e.g., ["Server", "Bartender"])
  eligibleUserIds   String[]          // Specific users who can claim (optional)

  // Claiming
  claimedBy         String?
  claimedByUser     User?             @relation("ClaimedBy", fields: [claimedBy], references: [id])
  claimedAt         DateTime?

  // Approval
  status            MarketplaceStatus @default(AVAILABLE)
  approvedBy        String?
  approvedAt        DateTime?
  rejectionReason   String?

  @@index([shiftId])
  @@index([status])
  @@index([availableUntil])
}

// Shift Swap Requests
model ShiftSwapRequest {
  id                String            @id @default(uuid())

  // Requester info
  requestedBy       String
  requester         User              @relation("RequestedBy", fields: [requestedBy], references: [id])
  requestedShiftId  String            // Shift requester wants to give away
  requestedShift    Shift             @relation("RequestedShift", fields: [requestedShiftId], references: [id])

  // Target info (optional - can be open swap)
  targetEmployee    String?
  targetUser        User?             @relation("TargetEmployee", fields: [targetEmployee], references: [id])
  offeredShiftId    String?           // Shift requester will take in exchange
  offeredShift      Shift?            @relation("OfferedShift", fields: [offeredShiftId], references: [id])

  reason            String
  createdAt         DateTime          @default(now())

  // Response
  status            SwapStatus        @default(PENDING)
  respondedBy       String?           // Manager or target employee
  respondedAt       DateTime?
  rejectionReason   String?

  @@index([requestedBy])
  @@index([targetEmployee])
  @@index([status])
}

// Time Off Requests
model TimeOffRequest {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  type              TimeOffType
  startDate         DateTime
  endDate           DateTime
  totalDays         Decimal           @db.Decimal(4, 1)  // Can be partial days

  reason            String?
  attachment        String?           // URL to doctor's note, etc.

  createdAt         DateTime          @default(now())

  // Approval workflow
  status            TimeOffStatus     @default(PENDING)
  approvedBy        String?
  approvedAt        DateTime?
  rejectionReason   String?

  // Accrual deduction
  deductedFrom      AccrualType?      // Which accrual balance to deduct from
  deductedDays      Decimal?          @db.Decimal(4, 1)

  @@index([userId])
  @@index([status])
  @@index([startDate, endDate])
}

// Accrual Balances (Vacation, Sick Time, Comp Time)
model AccrualBalance {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  type              AccrualType
  year              Int               // Accrual year

  // Balance tracking
  earnedDays        Decimal           @default(0) @db.Decimal(5, 2)
  usedDays          Decimal           @default(0) @db.Decimal(5, 2)
  remainingDays     Decimal           @default(0) @db.Decimal(5, 2)

  // Carry-over from previous year
  carryOverDays     Decimal?          @db.Decimal(5, 2)
  carryOverExpiry   DateTime?         // When carry-over expires

  // Norwegian vacation rules: 25 days/year (5 weeks)
  annualEntitlement Decimal           @default(25) @db.Decimal(5, 2)

  updatedAt         DateTime          @updatedAt

  @@unique([userId, type, year])
  @@index([userId])
  @@index([type])
}

// Labor Cost Tracking
model LaborCost {
  id                String            @id @default(uuid())
  rosterId          String?
  roster            Roster?           @relation(fields: [rosterId], references: [id])

  period            String            // "2024-W01" for weekly, "2024-01" for monthly
  periodStart       DateTime
  periodEnd         DateTime

  // Budgeted costs
  budgetedHours     Decimal           @db.Decimal(8, 2)
  budgetedCost      Decimal           @db.Decimal(10, 2)

  // Scheduled costs (from roster)
  scheduledHours    Decimal           @db.Decimal(8, 2)
  scheduledCost     Decimal           @db.Decimal(10, 2)
  scheduledRegularCost  Decimal       @db.Decimal(10, 2)
  scheduledOvertimeCost Decimal       @db.Decimal(10, 2)

  // Actual costs (from time tracking)
  actualHours       Decimal?          @db.Decimal(8, 2)
  actualCost        Decimal?          @db.Decimal(10, 2)
  actualRegularCost Decimal?          @db.Decimal(10, 2)
  actualOvertimeCost Decimal?         @db.Decimal(10, 2)

  // Variance
  variance          Decimal?          @db.Decimal(10, 2)
  variancePercent   Decimal?          @db.Decimal(5, 2)

  // Breakdown by department
  departmentBreakdown Json?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([rosterId])
  @@index([periodStart, periodEnd])
}

// Dashboard Metrics (Pre-calculated for performance)
model DashboardMetric {
  id                String            @id @default(uuid())
  organizationId    String
  locationId        String?

  metricType        MetricType
  period            String            // "2024-W01", "2024-01", etc.
  periodStart       DateTime
  periodEnd         DateTime

  // Metric data (flexible JSON for different metric types)
  data              Json

  calculatedAt      DateTime          @default(now())

  @@index([organizationId, metricType, period])
  @@index([locationId])
  @@index([periodStart, periodEnd])
}

// Employee preferences for AI scheduling
model EmployeePreference {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Time preferences
  preferredDays     String[]          // ["Monday", "Tuesday"]
  avoidDays         String[]
  preferMorning     Boolean           @default(false)
  preferEvening     Boolean           @default(false)
  preferNight       Boolean           @default(false)

  // Constraints
  maxHoursPerWeek   Int?
  minHoursPerWeek   Int?

  // Availability exceptions
  unavailableFrom   DateTime?
  unavailableTo     DateTime?
  unavailableReason String?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
}

// Actual hours worked (for audit trail)
model ActualHours {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id])

  // Actual time worked
  date              DateTime
  clockIn           DateTime
  clockOut          DateTime?
  breakMinutes      Int               @default(0)
  totalHours        Float

  // Classification
  isOvertime        Boolean           @default(false)
  overtimeHours     Float             @default(0)

  // Notes
  notes             String?
  approvedBy        String?
  approvedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

// Comments on rosters (for representatives and managers)
model RosterComment {
  id                String            @id @default(uuid())
  rosterId          String
  roster            Roster            @relation(fields: [rosterId], references: [id], onDelete: Cascade)

  userId            String
  user              User              @relation(fields: [userId], references: [id])

  content           String
  isResolved        Boolean           @default(false)

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([rosterId])
  @@index([userId])
}

// Notifications for employees
model Notification {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  type              String            // "ROSTER_PUBLISHED", "SHIFT_CHANGED", etc.
  title             String
  message           String

  isRead            Boolean           @default(false)
  readAt            DateTime?

  // Optional link to related entity
  relatedEntityType String?           // "Roster", "Shift", etc.
  relatedEntityId   String?

  createdAt         DateTime          @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// Audit log for Arbeidstilsynet compliance
model AuditLog {
  id                String            @id @default(uuid())

  // What happened
  action            String            // "ROSTER_CREATED", "SHIFT_CHANGED", etc.
  entityType        String            // "Roster", "Shift", "User"
  entityId          String

  // Who did it
  userId            String?
  userEmail         String?

  // When
  timestamp         DateTime          @default(now())

  // Details
  details           Json?             // Flexible JSON for storing change details
  ipAddress         String?

  // Optional relation to roster
  rosterId          String?
  roster            Roster?           @relation(fields: [rosterId], references: [id])

  // Retention (required by law: 2 years minimum)
  retainUntil       DateTime          // Calculated based on retention policy

  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
  @@index([retainUntil])
}

// Compliance reports (pre-generated for quick export)
model ComplianceReport {
  id                String            @id @default(uuid())

  // Report period
  startDate         DateTime
  endDate           DateTime

  // Report type
  reportType        String            // "ARBEIDSTILSYNET", "INTERNAL", etc.

  // Generated data
  generatedAt       DateTime          @default(now())
  generatedBy       String

  // Report data (stored as JSON for flexibility)
  data              Json

  // File storage (if exported to PDF/Excel)
  fileUrl           String?
  fileFormat        String?           // "PDF", "EXCEL", "JSON"

  createdAt         DateTime          @default(now())

  @@index([startDate, endDate])
  @@index([reportType])
}

// Direct messages between employees
model Message {
  id                String            @id @default(uuid())

  // Sender and recipient
  senderId          String
  sender            User              @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  recipientId       String
  recipient         User              @relation("MessagesReceived", fields: [recipientId], references: [id], onDelete: Cascade)

  // Optional roster context
  rosterId          String?
  roster            Roster?           @relation(fields: [rosterId], references: [id], onDelete: SetNull)

  // Message content
  content           String

  // Read tracking
  isRead            Boolean           @default(false)
  readAt            DateTime?

  // Threading support
  parentId          String?
  parent            Message?          @relation("MessageThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies           Message[]         @relation("MessageThread")

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([senderId])
  @@index([recipientId])
  @@index([rosterId])
  @@index([parentId])
  @@index([isRead])
  @@index([createdAt])
}

// Team/department broadcast messages
model Broadcast {
  id                String            @id @default(uuid())

  // Sender
  senderId          String
  sender            User              @relation("BroadcastsSent", fields: [senderId], references: [id], onDelete: Cascade)

  // Optional roster context
  rosterId          String?
  roster            Roster?           @relation(fields: [rosterId], references: [id], onDelete: SetNull)

  // Department targeting (optional)
  departmentId      String?

  // Broadcast content
  title             String
  content           String

  // Audience type
  audience          String            // "ALL", "DEPARTMENT", "ROSTER"

  createdAt         DateTime          @default(now())

  @@index([senderId])
  @@index([rosterId])
  @@index([departmentId])
  @@index([createdAt])
}

// ==========================================
// ZAPIER INTEGRATION
// ==========================================

// Zapier webhook subscriptions
model ZapierWebhook {
  id                String            @id @default(uuid())
  organizationId    String

  webhookUrl        String
  events            String[]          // Array of event types subscribed to
  secret            String            // HMAC signature secret

  isActive          Boolean           @default(true)
  errorCount        Int               @default(0)
  lastDeliveredAt   DateTime?
  lastErrorAt       DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Delivery log
  deliveries        ZapierWebhookDelivery[]

  @@index([organizationId])
  @@index([isActive])
}

// Zapier webhook delivery log
model ZapierWebhookDelivery {
  id                String            @id @default(uuid())
  webhookId         String
  webhook           ZapierWebhook     @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  eventType         String
  payload           Json
  statusCode        Int?
  success           Boolean
  errorMessage      String?

  createdAt         DateTime          @default(now())

  @@index([webhookId])
  @@index([eventType])
  @@index([createdAt])
}

// ==========================================
// MULTI-AGENT CONSENSUS SYSTEM
// ==========================================

// Consensus decision types
enum ConsensusDecisionType {
  SHIFT_ASSIGNMENT
  SCHEDULE_CREATION
  SHIFT_SWAP
  SCHEDULE_OPTIMIZATION
  CONFLICT_RESOLUTION
  COMPLIANCE_OVERRIDE
}

// Consensus status outcomes
enum ConsensusStatus {
  UNANIMOUS_APPROVE
  MAJORITY_APPROVE
  UNANIMOUS_REJECT
  MAJORITY_REJECT
  DEADLOCK
  ESCALATE
}

// User decision status
enum UserDecisionStatus {
  PENDING_REVIEW
  APPROVED
  MODIFIED
  REJECTED
}

// Stores consensus decisions for audit trail and user review
model ConsensusDecision {
  id                String            @id @default(uuid())

  // Decision context
  decisionType      ConsensusDecisionType
  rosterId          String?
  roster            Roster?           @relation(fields: [rosterId], references: [id])

  // The proposal that was evaluated (stored as JSON)
  proposal          Json

  // Consensus result
  consensusStatus   ConsensusStatus
  finalDecision     String            // 'approve' | 'reject' | 'escalate'
  votesFor          Int
  votesAgainst      Int
  abstentions       Int
  consensusScore    Int               // 0-100
  confidenceLevel   Int               // 0-100

  // Agent decisions (stored as JSON array)
  agentDecisions    Json

  // Debate rounds (stored as JSON array)
  debateRounds      Json?

  // Summary and key points
  summary           String
  keyReasons        String[]
  remainingConcerns String[]
  conditions        String[]

  // User interaction
  userStatus        UserDecisionStatus @default(PENDING_REVIEW)
  userEdits         Json?             // Any edits made by user
  userDecisionBy    String?           // User ID who made final decision
  userDecisionAt    DateTime?
  userReason        String?           // Reason for approval/rejection

  // Metadata
  requestedBy       String
  evaluationDurationMs Int
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Compliance retention (2 years minimum)
  retainUntil       DateTime

  // Relations
  agentEvaluations  AgentEvaluation[]

  @@index([rosterId])
  @@index([decisionType])
  @@index([consensusStatus])
  @@index([userStatus])
  @@index([createdAt])
  @@index([retainUntil])
}

// Stores individual agent evaluations for transparency
model AgentEvaluation {
  id                String            @id @default(uuid())

  // Link to consensus decision
  consensusId       String
  consensus         ConsensusDecision @relation(fields: [consensusId], references: [id], onDelete: Cascade)

  // Agent info
  agentRole         String
  agentName         String

  // Evaluation result
  recommendation    String            // 'approve' | 'approve_with_conditions' | 'reject' | 'needs_modification'
  confidence        Int               // 0-100
  score             Int               // 0-100
  scoreBreakdown    Json

  // Reasoning (transparent for users)
  reasoning         String[]
  concerns          String[]
  suggestions       String[]

  // Scoring components (detailed breakdown for editing)
  scoringComponents Json

  // User override (if user disagrees with agent)
  userOverrideApproved Boolean?
  userOverrideReason   String?

  createdAt         DateTime          @default(now())

  @@index([consensusId])
  @@index([agentRole])
}
