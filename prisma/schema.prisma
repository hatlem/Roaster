// Prisma Schema for Norwegian Labor Law Compliant Roster SaaS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User roles for RBAC
enum UserRole {
  ADMIN           // Full system access
  MANAGER         // Can create and publish rosters
  REPRESENTATIVE  // Employee representative (tillitsvalgt) - can review and comment
  EMPLOYEE        // Can view own schedule and submit preferences
}

// Roster status for workflow
enum RosterStatus {
  DRAFT           // Being created, not visible to employees
  IN_REVIEW       // Sent to representatives for approval
  PUBLISHED       // Published to employees
  ACTIVE          // Currently active roster period
  COMPLETED       // Past roster period
  ARCHIVED        // Archived for compliance (retained per law)
}

// Shift change reasons (for logging)
enum ChangeReason {
  SICK_LEAVE
  EMERGENCY
  EMPLOYEE_REQUEST
  OPERATIONAL_NEED
  CORRECTION
  OTHER
}

// User/Employee model
model User {
  id                String            @id @default(uuid())
  email             String            @unique
  passwordHash      String
  role              UserRole          @default(EMPLOYEE)

  // Personal information
  firstName         String
  lastName          String
  phoneNumber       String?

  // Employment details
  employeeNumber    String?           @unique
  department        String?
  position          String?
  hireDate          DateTime?

  // Settings
  isActive          Boolean           @default(true)
  preferredLocale   String            @default("no")

  // Timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lastLoginAt       DateTime?

  // Relations
  shiftsAssigned    Shift[]
  preferences       EmployeePreference[]
  comments          RosterComment[]
  notifications     Notification[]
  actualHours       ActualHours[]

  @@index([email])
  @@index([employeeNumber])
  @@index([role])
}

// Organization/Company model
model Organization {
  id                String            @id @default(uuid())
  name              String
  orgNumber         String            @unique  // Norwegian org number
  address           String?
  contactEmail      String
  contactPhone      String?

  // Compliance settings
  maxDailyHours     Int               @default(9)
  maxWeeklyHours    Int               @default(40)
  minDailyRest      Int               @default(11)
  minWeeklyRest     Int               @default(35)
  publishDeadline   Int               @default(14)  // Days before roster start

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  rosters           Roster[]
}

// Roster (vaktplan) model
model Roster {
  id                String            @id @default(uuid())
  organizationId    String
  organization      Organization      @relation(fields: [organizationId], references: [id])

  // Period
  name              String            // e.g., "January 2024 Schedule"
  startDate         DateTime
  endDate           DateTime

  // Status and workflow
  status            RosterStatus      @default(DRAFT)

  // 14-Day Rule tracking
  publishedAt       DateTime?         // When roster was published
  publishedBy       String?           // User ID who published
  isLatePublication Boolean           @default(false)  // Flag if published late

  // Approval workflow
  sentForReviewAt   DateTime?
  reviewedBy        String?           // Representative user ID
  reviewedAt        DateTime?
  reviewComments    String?

  // Metadata
  createdBy         String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  shifts            Shift[]
  comments          RosterComment[]
  auditLogs         AuditLog[]

  @@index([organizationId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([publishedAt])
}

// Shift model
model Shift {
  id                String            @id @default(uuid())
  rosterId          String
  roster            Roster            @relation(fields: [rosterId], references: [id], onDelete: Cascade)

  userId            String
  user              User              @relation(fields: [userId], references: [id])

  // Shift details
  startTime         DateTime
  endTime           DateTime
  breakMinutes      Int               @default(0)  // Unpaid break time

  // Location/department
  department        String?
  location          String?
  notes             String?

  // Compliance flags
  violatesRestPeriod Boolean          @default(false)
  violatesDailyLimit Boolean          @default(false)
  violatesWeeklyLimit Boolean         @default(false)
  isOvertime        Boolean           @default(false)

  // Change tracking
  isChanged         Boolean           @default(false)
  originalStartTime DateTime?
  originalEndTime   DateTime?
  changeReason      ChangeReason?
  changeNotes       String?
  changedAt         DateTime?
  changedBy         String?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([rosterId])
  @@index([userId])
  @@index([startTime, endTime])
  @@index([violatesRestPeriod, violatesDailyLimit, violatesWeeklyLimit])
}

// Employee preferences for AI scheduling
model EmployeePreference {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Time preferences
  preferredDays     String[]          // ["Monday", "Tuesday"]
  avoidDays         String[]
  preferMorning     Boolean           @default(false)
  preferEvening     Boolean           @default(false)
  preferNight       Boolean           @default(false)

  // Constraints
  maxHoursPerWeek   Int?
  minHoursPerWeek   Int?

  // Availability exceptions
  unavailableFrom   DateTime?
  unavailableTo     DateTime?
  unavailableReason String?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
}

// Actual hours worked (for audit trail)
model ActualHours {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id])

  // Actual time worked
  date              DateTime
  clockIn           DateTime
  clockOut          DateTime?
  breakMinutes      Int               @default(0)
  totalHours        Float

  // Classification
  isOvertime        Boolean           @default(false)
  overtimeHours     Float             @default(0)

  // Notes
  notes             String?
  approvedBy        String?
  approvedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

// Comments on rosters (for representatives and managers)
model RosterComment {
  id                String            @id @default(uuid())
  rosterId          String
  roster            Roster            @relation(fields: [rosterId], references: [id], onDelete: Cascade)

  userId            String
  user              User              @relation(fields: [userId], references: [id])

  content           String
  isResolved        Boolean           @default(false)

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([rosterId])
  @@index([userId])
}

// Notifications for employees
model Notification {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  type              String            // "ROSTER_PUBLISHED", "SHIFT_CHANGED", etc.
  title             String
  message           String

  isRead            Boolean           @default(false)
  readAt            DateTime?

  // Optional link to related entity
  relatedEntityType String?           // "Roster", "Shift", etc.
  relatedEntityId   String?

  createdAt         DateTime          @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// Audit log for Arbeidstilsynet compliance
model AuditLog {
  id                String            @id @default(uuid())

  // What happened
  action            String            // "ROSTER_CREATED", "SHIFT_CHANGED", etc.
  entityType        String            // "Roster", "Shift", "User"
  entityId          String

  // Who did it
  userId            String?
  userEmail         String?

  // When
  timestamp         DateTime          @default(now())

  // Details
  details           Json?             // Flexible JSON for storing change details
  ipAddress         String?

  // Optional relation to roster
  rosterId          String?
  roster            Roster?           @relation(fields: [rosterId], references: [id])

  // Retention (required by law: 2 years minimum)
  retainUntil       DateTime          // Calculated based on retention policy

  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
  @@index([retainUntil])
}

// Compliance reports (pre-generated for quick export)
model ComplianceReport {
  id                String            @id @default(uuid())

  // Report period
  startDate         DateTime
  endDate           DateTime

  // Report type
  reportType        String            // "ARBEIDSTILSYNET", "INTERNAL", etc.

  // Generated data
  generatedAt       DateTime          @default(now())
  generatedBy       String

  // Report data (stored as JSON for flexibility)
  data              Json

  // File storage (if exported to PDF/Excel)
  fileUrl           String?
  fileFormat        String?           // "PDF", "EXCEL", "JSON"

  createdAt         DateTime          @default(now())

  @@index([startDate, endDate])
  @@index([reportType])
}
